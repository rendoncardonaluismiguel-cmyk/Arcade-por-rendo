<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
<meta name="theme-color" content="#000010">
<title>Pepsiman ‚Äî PS1</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --blue:#0044ff;--blue2:#0088ff;--red:#ff0000;--silver:#ccddff;
  --dk:#000010;--btn:#00000a;--bb:#001144;--ba:#0033aa;--tx:#aaccff;
}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Courier New',monospace;touch-action:none;}

/* SPLASH */
#splash{
  position:fixed;inset:0;z-index:999;
  background:linear-gradient(180deg,#000015 0%,#000820 50%,#000 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;
  overflow:hidden;
}
#splash::before{
  content:'ü•§ PEPSI ü•§ PEPSI ü•§ PEPSI ü•§ PEPSI ü•§ PEPSI ü•§';
  position:absolute;top:5%;left:0;right:0;
  color:#001144;font-size:10px;letter-spacing:3px;text-align:center;
  white-space:nowrap;overflow:hidden;
  animation:ticker 10s linear infinite;pointer-events:none;
}
@keyframes ticker{from{text-indent:100%}to{text-indent:-200%}}
#splash::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:35%;
  background:linear-gradient(180deg,transparent,#000420);pointer-events:none;
}

/* Pepsi logo circle */
.pepsi-logo{
  width:90px;height:90px;border-radius:50%;
  background:linear-gradient(180deg,#0044ff 0%,#0044ff 47%,#fff 47%,#fff 53%,#ff0000 53%,#ff0000 100%);
  box-shadow:0 0 30px #0044ff88,0 0 60px #0022aa44;
  animation:logospin 4s ease-in-out infinite;
  flex-shrink:0;
}
@keyframes logospin{
  0%,100%{transform:rotate(-5deg) scale(1);box-shadow:0 0 30px #0044ff88}
  50%{transform:rotate(5deg) scale(1.05);box-shadow:0 0 50px #0088ffaa}
}

#splash h1{
  font-size:clamp(44px,16vw,82px);
  letter-spacing:4px;text-transform:uppercase;text-align:center;line-height:0.9;
  background:linear-gradient(180deg,#0066ff 0%,#0044ff 45%,#fff 45%,#fff 55%,#ff2200 55%,#cc0000 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 15px #0044ff88);
  animation:pepglow 2s ease-in-out infinite;
}
@keyframes pepglow{
  0%,100%{filter:drop-shadow(0 0 10px #0044ff66)}
  50%{filter:drop-shadow(0 0 25px #0088ffaa)}
}

#splash h2{
  font-size:clamp(11px,3.5vw,16px);color:var(--silver);
  letter-spacing:5px;text-shadow:0 0 10px var(--blue2);
  text-transform:uppercase;
}

.tagline{
  color:#001133;font-size:clamp(8px,2.5vw,11px);
  letter-spacing:3px;font-style:italic;
  text-align:center;
}

#splash .badge{
  color:var(--tx);font-size:clamp(7px,2vw,9px);
  letter-spacing:2px;border:1px solid #001144;
  padding:5px 16px;background:rgba(0,0,0,0.7);
  text-align:center;line-height:1.8;
}

#play-btn{
  padding:14px 48px;background:transparent;
  border:2px solid var(--blue2);color:var(--blue2);
  font-family:'Courier New',monospace;font-size:clamp(13px,3.5vw,16px);
  letter-spacing:4px;cursor:pointer;text-transform:uppercase;
  animation:glw 1.4s ease-in-out infinite;margin-top:4px;
}
@keyframes glw{0%,100%{box-shadow:0 0 12px #0033cc99}50%{box-shadow:0 0 28px #0088ffff,inset 0 0 10px #001ecc15}}
#play-btn:active{background:var(--blue2);color:#fff;animation:none;}

/* APP */
#app{display:none;flex-direction:column;width:100%;height:100%;}

#topbar{
  height:36px;min-height:36px;
  background:linear-gradient(90deg,#000,#00000d,#000);
  border-bottom:2px solid #001144;
  display:flex;align-items:center;justify-content:space-between;padding:0 12px;flex-shrink:0;
}
#topbar .logo{color:var(--blue2);font-size:11px;letter-spacing:3px;text-shadow:0 0 8px var(--blue2);}
.tbtn{background:none;border:1px solid #001144;color:var(--tx);font-size:15px;padding:3px 9px;cursor:pointer;border-radius:3px;}
.tbtn:active{background:var(--blue);color:#fff;}

#screen{
  flex:1;background:#000;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;min-height:0;
}
#screen::after{
  content:'';position:absolute;inset:0;pointer-events:none;z-index:5;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 4px);
}
#game{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
#game canvas{image-rendering:pixelated;image-rendering:crisp-edges;display:block;}

/* LOADING */
#loader{
  position:absolute;inset:0;z-index:10;
  background:radial-gradient(ellipse at center,#000010 0%,#000 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;
}
.l-logo{
  width:60px;height:60px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(180deg,#0044ff 0%,#0044ff 47%,#fff 47%,#fff 53%,#ff0000 53%,#ff0000 100%);
  animation:spin 2s linear infinite;box-shadow:0 0 20px #0044ff66;
}
@keyframes spin{to{transform:rotate(360deg)}}
#loader h2{color:var(--blue2);font-size:clamp(16px,5vw,28px);letter-spacing:4px;text-shadow:0 0 16px #0055ff;text-align:center;}
#loader h3{color:#ff3300;font-size:clamp(9px,2.5vw,12px);letter-spacing:3px;}

/* Download progress */
#dl-section{width:260px;display:flex;flex-direction:column;gap:6px;}
#lbar-wrap{width:100%;height:10px;border:1px solid #001144;background:#00000a;border-radius:2px;}
#lbar{height:100%;width:0%;background:linear-gradient(90deg,#0033cc,var(--blue2));box-shadow:0 0 8px var(--blue2);transition:width .1s;border-radius:2px;}
#dl-info{display:flex;justify-content:space-between;}
#lmsg{color:#112244;font-size:8px;letter-spacing:2px;}
#dl-speed{color:#112244;font-size:8px;letter-spacing:1px;}
#lerr{
  color:#ff4444;font-size:9px;display:none;
  text-align:center;max-width:300px;line-height:2;
  border:1px solid #440000;padding:10px;background:#0a0000;
}
.retry-btn{
  margin-top:8px;padding:8px 20px;background:transparent;
  border:1px solid #ff4444;color:#ff4444;
  font-family:'Courier New',monospace;font-size:9px;
  letter-spacing:2px;cursor:pointer;
}
.retry-btn:active{background:#ff4444;color:#000;}

#drive-note{
  color:#002244;font-size:7px;letter-spacing:1px;
  text-align:center;max-width:260px;line-height:2;
  margin-top:4px;
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="pepsi-logo"></div>
  <div class="badge">SONY PLAYSTATION ¬∑ 1999 ¬∑ JAP√ìN</div>
  <h1>PEPSI<br>MAN</h1>
  <h2>PLAYSTATION 1</h2>
  <div class="tagline">"PEPSI ‚Äî THE CHOICE OF A NEW GENERATION"</div>
  <button id="play-btn" onclick="boot()">ü•§ JUGAR</button>
  <div style="color:#000a1a;font-size:7px;letter-spacing:2px;margin-top:4px">DESCARGA DESDE GOOGLE DRIVE ¬∑ ~136MB</div>
</div>

<!-- APP -->
<div id="app">
  <div id="topbar">
    <div class="logo">ü•§ PEPSIMAN ‚Äî PLAYSTATION 1</div>
    <div style="display:flex;gap:6px">
      <button class="tbtn" onclick="toggleFS()">‚õ∂</button>
      <button class="tbtn" id="muteBtn" onclick="toggleMute()">üîä</button>
    </div>
  </div>

  <div id="screen">
    <div id="loader">
      <div class="l-logo"></div>
      <h2>PEPSIMAN</h2>
      <h3>PLAYSTATION 1 ¬∑ PCSX-REARMED</h3>
      <div id="dl-section">
        <div id="lbar-wrap"><div id="lbar"></div></div>
        <div id="dl-info">
          <div id="lmsg">INICIANDO...</div>
          <div id="dl-speed"></div>
        </div>
      </div>
      <div id="lerr">
        <div id="lerr-msg"></div>
        <button class="retry-btn" onclick="loadEmulator()">‚Ü∫ REINTENTAR</button>
      </div>
      <div id="drive-note">
        ‚ö†Ô∏è DESCARGANDO DESDE GOOGLE DRIVE<br>
        EL ARCHIVO PESA ~136MB ¬∑ ESPERA UN MOMENTO<br>
        NECESITAS CONEXI√ìN A INTERNET
      </div>
    </div>
    <div id="game"></div>
  </div>
</div>

<script>
const DRIVE_FILE_ID = "1CpnRDPAr5pztSwucv4r-kcoDEPrQSmcW";
const DRIVE_URL = `https://drive.usercontent.google.com/download?id=${DRIVE_FILE_ID}&export=download&confirm=t`;

function boot() {
  document.getElementById('splash').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  loadEmulator();
}

function setProgress(pct, msg, speed) {
  document.getElementById('lbar').style.width = pct + '%';
  document.getElementById('lmsg').textContent = msg;
  if (speed !== undefined) document.getElementById('dl-speed').textContent = speed;
}

function showError(msg) {
  document.getElementById('lerr-msg').textContent = msg;
  document.getElementById('lerr').style.display = 'block';
  document.getElementById('dl-section').style.display = 'none';
  document.getElementById('drive-note').style.display = 'none';
}

async function loadEmulator() {
  // Reset UI
  document.getElementById('lerr').style.display = 'none';
  document.getElementById('dl-section').style.display = 'flex';
  document.getElementById('drive-note').style.display = 'block';

  setProgress(0, 'CONECTANDO CON GOOGLE DRIVE...');

  try {
    // Fetch the ZIP from Google Drive
    setProgress(2, 'DESCARGANDO DESDE GOOGLE DRIVE...', '...');

    const startTime = Date.now();
    const response = await fetch(DRIVE_URL);

    if (!response.ok) throw new Error(`HTTP ${response.status} ‚Äî No se pudo descargar`);

    const contentLength = response.headers.get('Content-Length');
    const total = contentLength ? parseInt(contentLength) : 136 * 1024 * 1024;

    // Stream download with progress
    const reader = response.body.getReader();
    const chunks = [];
    let received = 0;
    let lastTime = Date.now();
    let lastReceived = 0;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      chunks.push(value);
      received += value.length;

      // Speed calculation
      const now = Date.now();
      if (now - lastTime > 500) {
        const bytesPerSec = (received - lastReceived) / ((now - lastTime) / 1000);
        const mbps = (bytesPerSec / 1024 / 1024).toFixed(1);
        const remaining = total > received ? ((total - received) / bytesPerSec).toFixed(0) : '?';
        const pct = Math.min(60, (received / total) * 60);
        setProgress(
          pct,
          `DESCARGANDO... ${(received/1024/1024).toFixed(1)}MB / ${(total/1024/1024).toFixed(0)}MB`,
          `${mbps} MB/s ¬∑ ~${remaining}s`
        );
        lastTime = now;
        lastReceived = received;
      }
    }

    setProgress(62, 'DESCOMPRIMIENDO ZIP...', '');

    // Combine chunks into single buffer
    const allChunks = new Uint8Array(received);
    let pos = 0;
    for (const chunk of chunks) {
      allChunks.set(chunk, pos);
      pos += chunk.length;
    }

    setProgress(65, 'EXTRAYENDO BIN/CUE...', '');

    // Use fflate to decompress ZIP
    await loadScript('https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js');
    const { unzipSync } = fflate;

    const files = unzipSync(allChunks);
    const fileNames = Object.keys(files);
    console.log('ZIP contents:', fileNames);

    // Find the main .bin and .cue files
    const binFile = fileNames.find(f => f.toLowerCase().includes('track 1') && f.toLowerCase().endsWith('.bin'))
                 || fileNames.find(f => f.toLowerCase().endsWith('.bin'));
    const cueFile = fileNames.find(f => f.toLowerCase().endsWith('.cue'));

    if (!binFile) throw new Error('No se encontr√≥ archivo .bin en el ZIP');

    setProgress(75, 'CREANDO BLOB URLs...', '');

    // Create blob URLs for the extracted files
    const binBlob = new Blob([files[binFile]], {type: 'application/octet-stream'});
    const binURL  = URL.createObjectURL(binBlob);

    let romURL = binURL;

    // If there's a CUE file, modify it to point to blob URL and use it
    if (cueFile) {
      let cueContent = new TextDecoder().decode(files[cueFile]);
      // Replace filename in CUE with blob URL reference
      const mainBinName = binFile.split('/').pop();
      cueContent = cueContent.replace(mainBinName, binURL);
      
      // Also create blob URLs for additional tracks
      const trackFiles = fileNames.filter(f => 
        f.toLowerCase().endsWith('.bin') && f !== binFile
      );
      for (const track of trackFiles) {
        const trackName = track.split('/').pop();
        const trackBlob = new Blob([files[track]], {type: 'application/octet-stream'});
        const trackURL  = URL.createObjectURL(trackBlob);
        cueContent = cueContent.replace(trackName, trackURL);
      }

      const cueBlob = new Blob([cueContent], {type: 'text/plain'});
      romURL = URL.createObjectURL(cueBlob);
    }

    setProgress(80, 'CARGANDO EMULADOR PS1...', '');

    // EmulatorJS config
    window.EJS_player          = '#game';
    window.EJS_core            = 'pcsx_rearmed';
    window.EJS_gameUrl         = romURL;
    window.EJS_gameName        = 'Pepsiman (Japan)';
    window.EJS_color           = '#0055ff';
    window.EJS_backgroundColor = '#000000';
    window.EJS_startOnLoaded   = true;
    window.EJS_pathtodata      = 'https://cdn.emulatorjs.org/stable/data/';
    window.EJS_VirtualGamepad  = true;
    window.EJS_Buttons = {
      gamepad:true, mute:true, settings:true, fullscreen:false,
      save:true, load:true, screenshot:false, cheat:false,
      volume:true, quickSave:true, quickLoad:true,
      zoom:false, crt:false, ratio:false, reset:true,
    };
    window.EJS_defaultOptions = {
      'save-state-slot': 1,
      'video-smooth': false,
    };

    window.EJS_onLoadProgress = function(p) {
      setProgress(80 + p * 18, 'CARGANDO CORE PS1... ' + Math.round(p*100) + '%', '');
    };

    window.EJS_onGameStart = function() {
      setProgress(100, 'ü•§ PEPSI!', '');
      setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 600);
    };

    await loadScript('https://cdn.emulatorjs.org/stable/data/loader.js');

  } catch(e) {
    console.error(e);
    showError(
      '‚ùå ERROR: ' + e.message + '

' +
      'Posibles causas:
' +
      '‚Ä¢ El archivo de Drive no es p√∫blico
' +
      '‚Ä¢ Sin conexi√≥n a internet
' +
      '‚Ä¢ Google Drive bloque√≥ la descarga

' +
      'Aseg√∫rate que el archivo en Drive
' +
      'sea accesible para "cualquiera con el enlace"'
    );
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = () => reject(new Error('No se pudo cargar: ' + src));
    document.head.appendChild(s);
  });
}

function toggleFS() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen({navigationUI:'hide'}).catch(()=>{});
    if (screen.orientation?.lock) screen.orientation.lock('landscape').catch(()=>{});
  } else { document.exitFullscreen?.(); }
}

let muted = false;
function toggleMute() {
  muted = !muted;
  document.getElementById('muteBtn').textContent = muted ? 'üîá' : 'üîä';
  if (window.EJS_emulator?.setVolume) EJS_emulator.setVolume(muted ? 0 : 1);
  document.querySelectorAll('audio,video').forEach(a => a.muted = muted);
}

document.addEventListener('touchmove', e => { if (e.touches.length > 1) e.preventDefault(); }, {passive:false});
document.addEventListener('gesturestart', e => e.preventDefault(), {passive:false});
</script>
</body>
</html>